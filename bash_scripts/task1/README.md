# Пояснение скрипта

## Что делает скрипт?

1. Формирует список хостов (32 штук), используя шаблон имени.
2. По очереди подключается к каждому хосту через SSH.
3. На каждом хосте ищет правила iptables с указанным IP-адресом и комментарием.
4. Если правило найдено, удаляет его из цепочки.
5. Все логи сохраняются в файл.

---

## Короткое объяснение по шагам

- `TARGET_IPS`, `COMMENT`, `CHAIN` — что ищем (адреса, комментарий, цепочка iptables).
- Цикл `for` по 32 хостам.
- Подключение через SSH.
- На хосте:
  - Вывод iptables-цепочки.
  - Поиск строк с IP-адресами и комментарием.
  - Удаление правил по номеру.
- Запись результатов в лог.

---

## Скрипт

```bash
#!/bin/bash

# Настройки
TARGET_IPS=("IP_1" "IP_2")
COMMENT="some comment"
CHAIN="CHAIN_NAME"
LOGFILE="cleanup_$(date +%F).log"
SSH_PORT="PORT"
SSH_USER="user"
HOST_PREFIX="host"

for i in $(seq 1 32); do
    HOST="${HOST_PREFIX}${i}.yourdomain.com"
    echo "[$HOST] Подключение..." | tee -a "$LOGFILE"

    ssh -p "$SSH_PORT" -o StrictHostKeyChecking=no "$SSH_USER@$HOST" bash -s -- <<'EOF' | tee -a "$LOGFILE"
#!/bin/bash
set -e

TARGET_IPS=("IP_1" "IP_2")
COMMENT="some comment"
CHAIN="CHAIN_NAME"

sudo iptables -L "$CHAIN" -n --line-numbers 2>/dev/null | tac | while read -r line; do
    for IP in "${TARGET_IPS[@]}"; do
        if [[ "$line" == *"$COMMENT"* && "$line" == *"$IP"* ]]; then
            RULE_NUM=$(echo "$line" | awk '{print $1}')
            sudo iptables -D "$CHAIN" "$RULE_NUM"
        fi
    done
done
EOF

done
```

---

# Почему скрипт сложный для простой задачи?

Задача — просто удалить записи в iptables, скрипт вышел большим, потому что:

- Нужно обрабатывать несколько серверов.
- Нужно подключаться **по SSH** безопасно и автоматически.
- Нужно **аккуратно удалять** только правильные правила, не трогая остальные.
- Нужно **вести логи** действий для последующей проверки.
- Удаление правил делается через **номера**, а не через IP, чтобы избежать ошибок и сдвига нумерации правил.
- Используется **обратный порядок** (через `tac`), чтобы удаление не нарушало порядок номеров правил в iptables.

---

# Пояснение команд и приёмов

- `for i in $(seq 1 32)` — цикл по числам от 1 до 32 для создания списка серверов.
- `ssh ... bash -s --` — передача скрипта на сервер по SSH.
- `set -e` — аварийное завершение при ошибке внутри скрипта.
- `iptables -L CHAIN -n --line-numbers` — показать цепочку с номерами правил.
- `tac` — реверс строк, чтобы удалять правила снизу вверх.
- `while read -r line; do ... done` — построчная обработка вывода.
- `if [[ "$line" == *"$COMMENT"* && "$line" == *"$IP"* ]]; then` — проверка, содержит ли строка нужный IP и комментарий.
- `awk '{print $1}'` — извлечение номера правила из строки.
- `iptables -D CHAIN RULE_NUM` — удаление правила по номеру.

---

# Генерация тестовых правил для iptables

```bash
sudo iptables -N CHAIN_NAME
sudo iptables -A CHAIN_NAME -s 192.0.2.1 -p tcp --dport 80 -j ACCEPT -m comment --comment "allow 192.0.2.1"
sudo iptables -A CHAIN_NAME -s 192.0.2.2 -p tcp --dport 443 -j ACCEPT -m comment --comment "allow 192.0.2.2"
sudo iptables -A CHAIN_NAME -s 198.51.100.1 -p tcp --dport 8080 -j ACCEPT -m comment --comment "allow 198.51.100.1"
```

---

# Задания

## Основное задание

Создай скрипт, который будет:

1. Добавлять в iptables цепочку `CHAIN_NAME`, если она отсутствует.
2. Добавлять правила для списка IP-адресов из файла `ips.txt`.
3. Устанавливать комментарий в формате `"allow IP_ADDRESS"` для каждого правила.
4. Логировать добавление правил в файл `iptables_add.log`.

## Дополнительные задания

- Реализовать проверку успешности добавления правила и выводить `[OK]` или `[ERROR]` в лог.
- Сделать скрипт параметризуемым: принимать название цепочки и имя файла с IP-адресами через аргументы командной строки.
- Добавить возможность удаления всех правил, у которых комментарий начинается с определённого префикса.

---

# Вопросы для самопроверки

1. Почему для удаления правил используется именно номер, а не IP-адрес?
2. Что может произойти, если удалять правила в порядке сверху вниз?
3. Зачем используется `tac` в обработке вывода iptables?
4. Какие опции SSH используются в скрипте для безопасного подключения?
5. Как сделать удаление только тех правил, которые соответствуют определённому шаблону комментария?
6. Что произойдет, если цепочка в iptables отсутствует?
7. Чем отличается `-L` от `-S` в iptables?
8. Как можно параллелить удаление правил на множестве серверов?
9. Как сохранить и восстановить iptables-правила после их удаления?

