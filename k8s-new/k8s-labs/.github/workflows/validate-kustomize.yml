name: validate-kustomize

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Check kubectl client
      run: kubectl version --client
    - name: Find kustomization files
      run: |
        set -euo pipefail
        found=0
        while IFS= read -r file; do
          found=1
          dir=$(dirname "$file")
          echo "Validating kustomize in $dir"
          kubectl kustomize "$dir" >/dev/null
        done < <(find . -type f \( -name 'kustomization.yaml' -o -name 'kustomization.yml' \))
        if [ "$found" -eq 0 ]; then
          echo "No kustomization files found, skip"
        fi
