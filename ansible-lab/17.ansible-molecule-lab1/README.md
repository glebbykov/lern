
# Лабораторная работа №14 

## Тема: Ansible и обеспечение качества с помощью Molecule

## Цель работы:
Познакомиться с фреймворком Molecule, его установкой, настройкой, а также практическими возможностями для тестирования ролей Ansible в одноразовых контейнерах и различных сценариях.

## Задания:

### 1. Установка и настройка Molecule
- Установите необходимые зависимости для Python и Molecule, если они отсутствуют.
- Создайте виртуальную среду для Python и установите Molecule с помощью `pip`.

### 2. Создание роли Ansible
- Создайте новую роль с именем `my_test_role` с использованием команды:
  ```bash
  ansible-galaxy role init my_test_role
  ```
- Ознакомьтесь со структурой каталога, созданного для роли.

### 3. Инициализация Molecule для роли
- Войдите в каталог роли `my_test_role` и инициализируйте Molecule для использования драйвера Docker:
  ```bash
  molecule init scenario -r my_test_role --driver-name docker
  ```
- Просмотрите файлы, созданные Molecule, и обратите внимание на сценарий по умолчанию `default`.

### 4. Настройка сценария Molecule для контейнеров Docker
- В файле `molecule/default/molecule.yml` укажите необходимую информацию для тестирования:
  - Задайте платформу `ubuntu` (или другую дистрибутивную систему).
  - Установите зависимости для Ansible.
- Добавьте в `converge.yml` задачи, проверяющие установку тестового пакета, например, `curl` или `vim`.

### 5. Тестирование роли
- Запустите Molecule для настройки контейнера:
  ```bash
  molecule converge
  ```
- Проверьте выполнение задач в сценарии и убедитесь, что роль установлена и работает корректно.
- Используйте команду `molecule idempotence`, чтобы убедиться в идемпотентности роли.

### 6. Проверка и удаление контейнера
- Для завершения тестирования выполните команду для проверки:
  ```bash
  molecule verify
  ```
- Завершите работу, удалив контейнер:
  ```bash
  molecule destroy
  ```

### 7. Создание дополнительного сценария для роли
- Добавьте новый сценарий `alternative` с использованием другой версии дистрибутива (например, `centos`).
- Выполните тестирование с помощью команд `molecule converge` и `molecule verify` для нового сценария.

## Вопросы для закрепления:
1. Что представляет собой Molecule, и как он используется в тестировании Ansible ролей?
2. Какую задачу решает Molecule при использовании контейнеров Docker для тестирования?
3. Какие преимущества дают тестовые сценарии Molecule в сравнении с тестированием на локальных машинах?
4. Почему важно проверять идемпотентность роли?
5. Как работают драйверы в Molecule, и какие драйверы можно использовать для работы с публичными и частными облаками?

---

# Дополнительные задания к лабораторной работе по теме Ansible и Molecule

## Дополнительное задание 1: Настройка и тестирование Redis кластера
1. Сконфигурируйте Molecule для создания трех контейнеров Redis в одной сети, как в примере для Redis Sentinel.
2. Настройте кластер так, чтобы один экземпляр Redis был ведущим, а остальные – ведомыми.
3. Проверьте настройку кластера с помощью команды `molecule converge`, а затем проверьте состояние каждого контейнера.

## Дополнительное задание 2: Настройка сценария для тестирования на нескольких дистрибутивах
1. Создайте сценарий Molecule с именем `multi_distro`.
2. В `molecule.yml` добавьте несколько платформ: `ubuntu` и `centos`.
3. Убедитесь, что роль корректно работает на обеих платформах, протестировав её с помощью `molecule converge`.

## Дополнительное задание 3: Настройка Molecule для запуска линтеров
1. В файле `molecule/default/molecule.yml` добавьте линтеры для проверки синтаксиса YAML и Ansible.
2. Запустите Molecule с параметром `molecule lint`, чтобы проверить синтаксис роли.
3. Проанализируйте результаты, исправьте ошибки, если они найдены.

## Дополнительное задание 4: Создание сценария для тестирования конфигураций
1. Создайте два новых файла: `present.yml` и `absent.yml` в каталоге `tasks` роли.
2. Настройте роль так, чтобы в зависимости от переменной `desired_state` Molecule выполнял разные задачи:
   - `present.yml` — задача установки определенного пакета.
   - `absent.yml` — задача удаления этого пакета.
3. Проверьте работу данной конфигурации с помощью Molecule, используя переменные на разных платформах.
