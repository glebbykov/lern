
# Лабораторная работа: Использование переменных в Ansible 2

## Цель:
Научиться создавать и управлять переменными в Ansible, а также использовать их в сценариях для настройки конфигурации хостов.

## Требования:
- Установленная Ansible.
- Доступ к хостам для выполнения сценариев.

## Задание 1: Объявление переменных в Playbook
1. Создайте playbook, в котором объявите несколько переменных.
   ```yaml
   - name: Настройка веб-сервера
     hosts: web
     vars:
       http_port: 80
       max_clients: 200
     tasks:
       - name: Установка пакета Apache
         apt:
           name: apache2
           state: present
           update_cache: yes

       - name: Конфигурация Apache
         template:
           src: apache.j2
           dest: /etc/apache2/sites-available/000-default.conf
   ```
2. Создайте файл шаблона `apache.j2` для конфигурации Apache:
   ```
   <VirtualHost *:{{ http_port }}>
       DocumentRoot /var/www/html
       MaxClients {{ max_clients }}
   </VirtualHost>
   ```
3. Запустите сценарий и убедитесь, что сервер настроен с указанными параметрами.

## Задание 2: Использование фактов (facts)
1. Создайте playbook, который выводит информацию о системе.
   ```yaml
   - name: Получение системной информации
     hosts: all
     tasks:
       - name: Вывести информацию о хосте
         debug:
           var: ansible_facts
   ```
2. Запустите playbook и проанализируйте вывод системных фактов. Обратите внимание на такие параметры, как архитектура, операционная система, версия ядра и т.д.

## Задание 3: Использование переменных из инвентарного файла
1. Добавьте переменные в ваш инвентарный файл:
   ```
   [web]
   web1 ansible_host=192.168.1.10 http_port=8080 max_clients=300
   web2 ansible_host=192.168.1.11 http_port=9090 max_clients=500
   ```
2. Модифицируйте ваш playbook, чтобы использовать переменные из инвентарного файла:
   ```yaml
   - name: Настройка веб-сервера с переменными из инвентаря
     hosts: web
     tasks:
       - name: Конфигурация Apache
         template:
           src: apache.j2
           dest: /etc/apache2/sites-available/000-default.conf
   ```

## Задание 4: Групповые переменные
1. Создайте директорию `group_vars` и добавьте файл для группы `web`:
   ```
   group_vars/web.yml
   ```
   В этом файле объявите общие переменные:
   ```yaml
   http_port: 8080
   max_clients: 250
   ```
2. Проверьте, что сценарий корректно использует переменные из групповых файлов.

## Задание 5: Переменные командной строки
1. Запустите playbook с переменными, передаваемыми через командную строку:
   ```
   ansible-playbook site.yml -e "http_port=8000 max_clients=150"
   ```
2. Убедитесь, что параметры применились, и playbook использовал переданные переменные.

## Дополнительные задания:
1. **Создание структуры данных:** Создайте playbook, где переменные будут представлять собой словари и списки. Используйте их для конфигурации нескольких виртуальных хостов с разными настройками.
   ```yaml
   vars:
     virtual_hosts:
       - { name: "site1", port: 8080, document_root: "/var/www/site1" }
       - { name: "site2", port: 9090, document_root: "/var/www/site2" }
   tasks:
     - name: Настройка виртуальных хостов
       template:
         src: vhost.j2
         dest: /etc/apache2/sites-available/{{ item.name }}.conf
       with_items: "{{ virtual_hosts }}"
   ```

2. **Использование внешнего файла:** Создайте YAML-файл с переменными и используйте его в playbook. Пример файла `vars/external_vars.yml`:
   ```yaml
   http_port: 8080
   max_clients: 100
   ```
   Включите этот файл в playbook:
   ```yaml
   - name: Использование внешних переменных
     hosts: web
     vars_files:
       - vars/external_vars.yml
   ```

3. **Приоритет переменных:** Создайте playbook, в котором есть переменные из инвентаря, групповых файлов, playbook, и командной строки. Запустите playbook и изучите, какие переменные берут приоритет в разных случаях.

4. **Переменные по умолчанию:** Создайте роли с переменными по умолчанию (default), и создайте сценарий, в котором эти переменные будут переопределяться из командной строки.

## Вопросы для самопроверки:
1. Как использовать системные факты (facts) в сценариях Ansible?
2. Как передать переменные через инвентарный файл?
3. Что такое групповые переменные и как они применяются?
4. Как передать переменные в Ansible через командную строку?
5. Какие есть методы переопределения переменных в Ansible?
