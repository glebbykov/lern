
# Лабораторная работа 12: Управление хостами, задачами и обработчиками в Ansible

## Цель:
Научиться эффективно управлять хостами, задачами и обработчиками в Ansible, используя шаблоны для выбора хостов, обработку задач на управляющих машинах и делегирование задач.

## Задачи:
1. Изучение шаблонов для выбора хостов.
2. Использование механизма делегирования для выполнения задач на других машинах.
3. Последовательное выполнение задач с использованием выражения `serial`.
4. Применение `run_once` для однократного выполнения задач.
5. Работа с обработчиками и управление временем их выполнения.

### Задание 1: Использование шаблонов для выбора хостов
1. Создайте playbook, который запускает задачи на всех хостах группы `web`.
2. Модифицируйте playbook так, чтобы задачи выполнялись только на хостах, принадлежащих к группам `staging` и `database`.

Пример:
```yaml
- name: Операции на хостах staging и database
  hosts: staging:&database
  tasks:
    - name: Пинг всех хостов
      ping:
```

### Задание 2: Делегирование задач на управляющую машину
1. Создайте задачу, которая загружает файл с интернета на управляющую машину с помощью выражения `delegate_to`.

Пример:
```yaml
- name: Download goss binary
  delegate_to: localhost
  get_url:
    url: "https://example.com/goss"
    dest: "~/Downloads/goss"
```

2. Модифицируйте задачу так, чтобы она игнорировала ошибки, если загрузка не удалась.

### Задание 3: Последовательное выполнение задач на хостах
1. Создайте сценарий, который выполняет обновление пакетов на хостах группы `myhosts`, используя выражение `serial`, чтобы обновление выполнялось последовательно по одному хосту.

Пример:
```yaml
- name: Upgrade packages on servers
  hosts: myhosts
  serial: 1
  tasks:
    - name: Upgrade system packages
      apt:
        update_cache: true
        upgrade: dist
```

2. Добавьте выражение `max_fail_percentage`, чтобы остановить сценарий, если более 25% хостов потерпят неудачу.

### Задание 4: Однократное выполнение задач
1. Добавьте в сценарий задачу, которая выполняется только один раз на всех хостах с использованием выражения `run_once`.

Пример:
```yaml
- name: Выполнить миграцию базы данных
  command: /opt/run_migrations
  run_once: true
```

### Задание 5: Использование обработчиков
1. Создайте сценарий с обработчиком, который будет перезапускать службу Nginx только после изменения конфигурации.

Пример:
```yaml
- name: Настройка Nginx
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify: Перезапуск Nginx

handlers:
  - name: Перезапуск Nginx
    service:
      name: nginx
      state: restarted
```

2. Используйте модуль `meta: flush_handlers`, чтобы обработчики были вызваны немедленно после выполнения задачи, которая их вызывает.

## Дополнительные задания:
1. **Шаблоны выбора хостов**: Создайте сценарий, который будет выполняться на хостах, соответствующих регулярному выражению (например, `~web\d\.example\.com`).
2. **Сложные операции с обработчиками**: Создайте два обработчика, один из которых уведомляет другой. Например, после изменения конфигурации Apache, выполните проверку конфигурации перед его перезапуском.
3. **Асинхронные задачи**: Создайте задачу, которая будет выполняться асинхронно, и используйте модуль `async` для управления временем выполнения.

## Вопросы для самопроверки:
1. Как работают шаблоны для выбора хостов в Ansible? Приведите примеры шаблонов.
2. Как можно делегировать выполнение задачи на другую машину? В каких случаях это бывает полезно?
3. Что делает выражение `serial` и когда оно может быть полезным?
4. Как работает выражение `run_once` и в каких сценариях оно используется?
5. Как работают обработчики в Ansible и как управлять их выполнением?
