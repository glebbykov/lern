# Подробная инструкция по настройке сетевого моста с veth в Linux

В этой инструкции описано, как настроить сетевой мост в Linux, подключить к нему виртуальные интерфейсы veth и проверить связь между ними. Мы рассмотрим каждый шаг подробно.

---

## Задачи

1. Удалим старые мосты.
2. Создадим новый мостовой интерфейс `br0`.
3. Настроим два сетевых пространства имён (`ns1` и `ns2`).
4. Подключим пространства имён к мосту с помощью veth-пар.
5. Назначим IP-адреса виртуальным интерфейсам.
6. Проверим связь между пространствами имён через мост с помощью `ping`.

> **Важно:** Используй root.

---

## Основные понятия

### Сетевой мост (bridge)

Сетевой мост — это виртуальный сетевой интерфейс, работающий на втором уровне модели OSI. Он позволяет соединить несколько интерфейсов в одну логическую сеть. Мост действует как коммутатор, пересылая пакеты между интерфейсами, подключёнными к нему.

Используется для:

- Организации сетевой связи между виртуальными машинами или контейнерами.
- Соединения различных физических и виртуальных сетей.

В Linux сетевые мосты создаются и управляются с помощью утилит `ip` и `brctl`.

### Пространство имён (network namespace)

Сетевое пространство имён — это изолированная сетевое среда, в которой можно настроить свои интерфейсы, маршруты и правила. Пространства имён позволяют запускать процессы в изолированной сети, что полезно для контейнеризации и тестирования сетевых конфигураций.

Преимущества:

- Изоляция сетей.
- Возможность создавать уникальные сетевые настройки для разных приложений.

Создание пространства имён осуществляется с помощью команды `ip netns add`.

### veth (виртуальный Ethernet)

`veth` — это пара виртуальных сетевых интерфейсов, соединённых друг с другом. Всё, что отправляется на один интерфейс, сразу же появляется на другом. Эти интерфейсы используются для связи между пространствами имён или контейнерами через мосты.

Особенности:

- Пакеты пересылаются мгновенно между интерфейсами пары.
- Один из интерфейсов может быть перемещён в другое сетевое пространство имён.

`veth` создаётся с помощью команды `ip link add` с указанием типа `veth`.

---

## 1. Удаление старого мостового интерфейса

Если на сервере уже есть мосты (например, `br0`), их нужно удалить. Это предотвратит конфликты при создании нового моста.

Команда для удаления моста `br0`:

```bash
ip link delete br0 type bridge
```

> **Примечание:** Если у вас есть другие мосты, удалите их аналогичным образом, подставив соответствующие имена.

---

## 2. Создание нового мостового интерфейса

Создадим новый мостовой интерфейс с именем `br0` и активируем его.

### Команды:

1. Создаём мост:

   ```bash
   ip link add name br0 type bridge
   ```

2. Поднимаем мост:

   ```bash
   ip link set dev br0 up
   ```

На этом этапе мост готов к подключению виртуальных интерфейсов.

---

## 3. Создание сетевых пространств имён и veth-пар

### Что такое сетевые пространства имён?

Сетевые пространства имён (network namespaces) позволяют изолировать сетевую среду. Мы создадим два пространства: `ns1` и `ns2`, которые будут взаимодействовать через мост.

### 3.1. Создание пространств имён

1. Создаём пространство имён `ns1`:

   ```bash
   ip netns add ns1
   ```

2. Создаём пространство имён `ns2`:

   ```bash
   ip netns add ns2
   ```

### 3.2. Создание veth-пар

Для подключения пространств имён к мосту создаём пары виртуальных Ethernet-интерфейсов (veth).

#### Что такое veth?

`veth` (виртуальный Ethernet) — это пара соединённых интерфейсов. Всё, что передаётся на один конец, мгновенно появляется на другом.

#### Настройка veth для `ns1`:

1. Создаём пару интерфейсов: `veth-h1` и `veth-ns1`:

   ```bash
   ip link add veth-h1 type veth peer name veth-ns1
   ```

2. Перемещаем один из интерфейсов (`veth-ns1`) в пространство `ns1`:

   ```bash
   ip link set veth-ns1 netns ns1
   ```

3. Подключаем интерфейс `veth-h1` к мосту:

   ```bash
   ip link set veth-h1 master br0
   ```

4. Активируем интерфейс `veth-h1`:

   ```bash
   ip link set dev veth-h1 up
   ```

#### Настройка veth для `ns2`:

1. Создаём пару интерфейсов: `veth-h2` и `veth-ns2`:

   ```bash
   ip link add veth-h2 type veth peer name veth-ns2
   ```

2. Перемещаем один из интерфейсов (`veth-ns2`) в пространство `ns2`:

   ```bash
   ip link set veth-ns2 netns ns2
   ```

3. Подключаем интерфейс `veth-h2` к мосту:

   ```bash
   ip link set veth-h2 master br0
   ```

4. Активируем интерфейс `veth-h2`:

   ```bash
   ip link set dev veth-h2 up
   ```

---

## 4. Назначение IP-адресов

Назначим IP-адреса интерфейсам в пространствах имён для их взаимодействия через мост.

### Для пространства `ns1`:

1. Назначаем IP-адрес `10.0.0.1/24` интерфейсу `veth-ns1`:

   ```bash
   ip netns exec ns1 ip addr add 10.0.0.1/24 dev veth-ns1
   ```

2. Активируем интерфейс `veth-ns1`:

   ```bash
   ip netns exec ns1 ip link set dev veth-ns1 up
   ```

3. Поднимаем loopback-интерфейс:

   ```bash
   ip netns exec ns1 ip link set dev lo up
   ```

### Для пространства `ns2`:

1. Назначаем IP-адрес `10.0.0.2/24` интерфейсу `veth-ns2`:

   ```bash
   ip netns exec ns2 ip addr add 10.0.0.2/24 dev veth-ns2
   ```

2. Активируем интерфейс `veth-ns2`:

   ```bash
   ip netns exec ns2 ip link set dev veth-ns2 up
   ```

3. Поднимаем loopback-интерфейс:

   ```bash
   ip netns exec ns2 ip link set dev lo up
   ```

---

## 5. Проверка связи с помощью ping

Теперь проверим, что пространства имён могут взаимодействовать через мост.

### Проверка:

Выполним команду `ping` из пространства `ns1` в `ns2`:

```bash
ip netns exec ns1 ping -c 3 10.0.0.2
```

Если настройка выполнена правильно, вы увидите успешный обмен пакетами.

---

## 6. Полный скрипт

### Дополнительное задание: Работа с Netfilter и iptables

Для углублённого изучения сетевых технологий в Linux выполните следующее задание:

1. Настройте правила iptables для фильтрации пакетов между пространствами имён `ns1` и `ns2`.
2. Убедитесь, что:
   - Пакеты ICMP (ping) разрешены.
   - Пакеты TCP блокируются.

### Пример решения:

1. Создайте правило для разрешения ICMP-трафика:

   ```bash
   ip netns exec ns1 iptables -A OUTPUT -p icmp -j ACCEPT
   ip netns exec ns2 iptables -A INPUT -p icmp -j ACCEPT
   ```

2. Создайте правило для блокировки TCP-трафика:

   ```bash
   ip netns exec ns1 iptables -A OUTPUT -p tcp -j DROP
   ip netns exec ns2 iptables -A INPUT -p tcp -j DROP
   ```

3. Проверьте настройки, используя `ping` и утилиту `nc` (netcat):

   - Успешно выполнить `ping` из `ns1` в `ns2`:
     ```bash
     ip netns exec ns1 ping -c 3 10.0.0.2
     ```
   - Убедитесь, что соединение по TCP заблокировано:
     ```bash
     i
     ```

root\@br1:\~# ip netns exec ns1 ping -c 3 10.0.0.2

PING 10.0.0.2 (10.0.0.2) 56(84) bytes of data.

64 bytes from 10.0.0.2: icmp\_seq=1 ttl=64 time=0.076 ms

64 bytes from 10.0.0.2: icmp\_seq=2 ttl=64 time=0.078 ms

^C

\--- 10.0.0.2 ping statistics ---

2 packets transmitted, 2 received, 0% packet loss, time 1026ms

rtt min/avg/max/mdev = 0.076/0.077/0.078/0.001 ms

root\@br1:\~# ip netns exec ns1 nc -zv 10.0.0.2 80

exec of "nc" failed: No such file or directoryНиже представлен полный скрипт для автоматизации всех описанных шагов. Сохраните его в файл, например, `setup_bridge.sh`, и выполните от имени root.

Ниже представлен полный скрипт для автоматизации всех описанных шагов. Сохраните его в файл, например, `setup_bridge.sh`, и выполните от имени root.

```bash
#!/bin/bash
# Удаление старого моста
ip link delete br0 type bridge 2>/dev/null

# Создание нового моста
ip link add name br0 type bridge
ip link set dev br0 up

# Создание сетевых пространств имён
ip netns add ns1
ip netns add ns2

# Настройка veth для ns1
ip link add veth-h1 type veth peer name veth-ns1
ip link set veth-ns1 netns ns1
ip link set veth-h1 master br0
ip link set dev veth-h1 up

# Настройка veth для ns2
ip link add veth-h2 type veth peer name veth-ns2
ip link set veth-ns2 netns ns2
ip link set veth-h2 master br0
ip link set dev veth-h2 up

# Назначение IP-адресов
ip netns exec ns1 ip addr add 10.0.0.1/24 dev veth-ns1
ip netns exec ns1 ip link set dev veth-ns1 up
ip netns exec ns1 ip link set dev lo up

ip netns exec ns2 ip addr add 10.0.0.2/24 dev veth-ns2
ip netns exec ns2 ip link set dev veth-ns2 up
ip netns exec ns2 ip link set dev lo up

# Проверка связи
ip netns exec ns1 ping -c 3 10.0.0.2
```

### Использование скрипта:

1. Сделайте файл исполняемым:

   ```bash
   chmod +x setup_bridge.sh
   ```

2. Запустите скрипт:

   ```bash
   sudo ./setup_bridge.sh
   ```

---

## Заключение

В результате этой настройки:

- Создан новый мостовой интерфейс `br0`.
- Настроены два пространства имён (`ns1` и `ns2`).
- Пространства имён подключены к мосту через veth.
- Успешно проверена связь между пространствами через `ping`.
