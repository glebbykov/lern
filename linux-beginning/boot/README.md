# Процесс загрузки Linux-сервера с использованием UEFI

Загрузка Linux-сервера в режиме UEFI (Unified Extensible Firmware Interface) — это многоэтапный процесс, включающий в себя инициализацию аппаратного обеспечения, поиск загрузочных приложений, запуск ядра и инициализацию пользовательских сервисов. Ниже приведено детальное описание каждого шага.

## 1. Инициализация прошивки UEFI

1. **Power-On Self-Test (POST):**  
   После включения питания микрокод процессора инициализируется, а прошивка (UEFI) запускает процедуру Power-On Self-Test, проверяя:
   - Работоспособность центрального процессора.
   - Доступность и корректную установку оперативной памяти (RAM).
   - Подключение основных устройств ввода-вывода (клавиатура, видеокарта, базовые накопители).
   
   Цель: убедиться, что оборудование функционирует достаточно стабильно для продолжения загрузки.

2. **Инициализация устройств UEFI:**  
   После POST прошивка UEFI загружает свои собственные драйверы и расширения, необходимые для взаимодействия с аппаратными компонентами. Например:
   - Инициализация контроллеров хранения данных (SATA, NVMe).
   - Активация сетевых интерфейсов (при необходимости сетевой загрузки).
   - Настройка видеоадаптера для вывода интерфейса UEFI.

   На этом этапе формируется среда, в которой могут работать UEFI-приложения, включая загрузчик ОС.

## 2. Поиск и запуск загрузчика

1. **EFI System Partition (ESP):**  
   Стандарт UEFI предполагает наличие специального раздела на диске — EFI System Partition. Этот раздел:
   - Отформатирован в FAT32.
   - Содержит набор исполняемых файлов (*.efi), являющихся загрузчиками или вспомогательными средствами.

   Пример пути к загрузчику:  
   `\EFI\BOOT\BOOTX64.EFI` — дефолтный загрузчик для 64-битных UEFI систем.

2. **Выбор загрузочного приложения:**  
   Прошивка UEFI ссылается на переменные загрузки (Boot Variables), хранящиеся во внутренней энергонезависимой памяти. Эти переменные указывают на конкретные файлы внутри ESP, которые нужно запустить. Например, может быть указано `\EFI\redhat\grubx64.efi` или `\EFI\systemd\systemd-bootx64.efi`.

   Если соответствующие загрузчики не найдены или недоступны, UEFI пытается использовать предопределённые пути или переходит к следующему в списке загрузок.

3. **Запуск загрузчика:**  
   После успешного нахождения и выбора загрузчика UEFI передает ему управление. Загрузчик получает доступ к среде UEFI и к устройствам, уже инициализированным прошивкой.

## 3. Действия загрузчика (GRUB2, systemd-boot, rEFInd и т.д.)

1. **Отображение меню загрузки:**  
   Загрузчик предоставляет интерактивное меню, позволяющее пользователю:
   - Выбрать конкретное ядро Linux для загрузки.
   - Выбрать другой вариант ОС (при мультизагрузке).
   - Настроить параметры командной строки ядра.

2. **Загрузка ядра Linux и initrd:**  
   После выбора пункта меню загрузчик:
   - Загружает в память образ ядра Linux (`vmlinuz` или `bzImage`).
   - Загружает initrd (initial ramdisk) — временную файловую систему, содержащую драйверы и скрипты инициализации, необходимые для монтирования корневой файловой системы.

   Загрузчик передает ядру указатель на initrd и необходимые параметры (например, путь к корневой ФС, параметры сетевых интерфейсов).

## 4. Инициализация ядра

1. **Распаковка и запуск ядра:**  
   Ядро распаковывается в оперативную память и начинает выполнение стартовых функций. На этом этапе ядро:
   - Инициализирует системный таймер, планировщик процессов и модули управления памятью.
   - Подключает драйверы для обнаруженного оборудования.
   - Готовит окружение для монтирования корневой файловой системы.

2. **Исполнение init-процесса:**  
   После базовой инициализации ядро монтирует временную корневую ФС (из initrd), выполняет скрипты из initramfs и затем монтирует постоянную корневую файловую систему.  
   
   Завершающим этапом является запуск процесса `init` (в современных системах — `systemd`), который станет родительским для всех последующих процессов. Он управляет запуском сервисов, демонов и пользовательских процессов.

## 5. Запуск пользовательских сервисов

1. **Работа systemd (или другого init):**  
   `systemd` анализирует набор юнитов (service, socket, target и т.д.) и запускает их в определенной последовательности, прописанной в конфигурации. Это включает:
   - Активацию сетевых сервисов.
   - Запуск логирования, систем мониторинга.
   - Инициализацию SSH, HTTP, баз данных или других прикладных демонов.

2. **Готовность системы к работе:**  
   После запуска всех необходимых системных служб сервер становится полностью функциональным. Администратор или пользователь могут:
   - Подключаться к системе по сети или консоли.
   - Запускать приложения и управлять сервисами.
   - Выполнять любые задачи, для которых предназначен сервер.

---

## Схематическое представление процесса

```text
[ Power ON ]
       |
       v
   +---+---+   
   |   UEFI  | -- POST --> Инициализация устройств
   +---+---+
       |
       v
   [ Проверка Boot Variables ] --> [ ESP Partition ] --> [ Загрузчик (EFI приложение) ]
       |
       v
   [ Меню загрузчика ] --> [ Загрузка ядра и initrd ]
       |
       v
     [ Ядро Linux ] --> [ Инициализация оборудования, монтирование корневой ФС ]
       |
       v
     [ init/systemd ] --> [ Запуск сервисов, демонов, подготовка к работе ]
       |
       v
   [ Система готова к использованию ]
