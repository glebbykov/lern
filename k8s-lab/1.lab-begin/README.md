
# Лабораторная работа 1: Первые шаги с Docker и Kubernetes

## Цели

- Освоить основы работы с Docker: создание, запуск и распространение контейнеров.
- Научиться развертывать приложение в Kubernetes на полноценном кластере.
- Изучить настройки клиента командной строки `kubectl`.
- Ознакомиться с базовыми объектами Kubernetes: модули (pods), службы (services), контроллеры репликации (replication controllers).
- Выполнить горизонтальное масштабирование приложения в Kubernetes.

---

## Задания

### 1. Установка Docker и запуск контейнера Hello World

1. Установите Docker, следуя инструкциям на [официальном сайте](http://docs.docker.com/engine/installation/).
2. Проверьте установку, запустив команду:
   ```bash
   docker run busybox echo "Hello world"
   ```
3. Ответьте на вопросы:
   - Что произошло после выполнения команды `docker run`?
   - Где хранятся скачанные образы?

---

### 2. Создание простого приложения Python

1. Создайте файл `app.py` со следующим содержимым:
   ```python
   from http.server import BaseHTTPRequestHandler, HTTPServer
   import socket

   class RequestHandler(BaseHTTPRequestHandler):
       def do_GET(self):
           self.send_response(200)
           self.send_header('Content-type', 'text/plain')
           self.end_headers()
           hostname = socket.gethostname()
           self.wfile.write(f"You've hit {hostname}\n".encode('utf-8'))

   def run():
       print("Starting server...")
       server_address = ('', 8080)
       httpd = HTTPServer(server_address, RequestHandler)
       print("Server running...")
       httpd.serve_forever()

   if __name__ == "__main__":
       run()
   ```
2. Убедитесь, что файл сохранен в текущем каталоге.

---

### 3. Упаковка приложения в контейнерный образ

1. Создайте файл `Dockerfile`:
   ```dockerfile
   FROM python:3.9
   ADD app.py /app.py
   ENTRYPOINT ["python", "app.py"]
   ```
2. Соберите образ с тегом `kubia`:
   ```bash
   docker build -t kubia .
   ```
3. Проверьте, что образ создан, используя команду:
   ```bash
   docker images
   ```
4. Запустите контейнер:
   ```bash
   docker run --name kubia-container -p 8080:8080 -d kubia
   ```
5. Ответьте на вопросы:
   - Как проверить, что контейнер работает?
   - Как зайти внутрь контейнера для изучения его содержимого?

---

### 4. Размещение образа в Docker Hub

1. Создайте учетную запись на [Docker Hub](https://hub.docker.com).
2. Перетегируйте образ:
   ```bash
   docker tag kubia <ваш_docker_hub_id>/kubia
   ```
3. Отправьте образ в Docker Hub:
   ```bash
   docker push <ваш_docker_hub_id>/kubia
   ```
4. Ответьте на вопросы:
   - Какие команды используются для загрузки и запуска образа на другой машине?

---

### 5. Настройка полноценного кластера Kubernetes с Kubespray

1. Настройте кластер Kubernetes с помощью [Kubespray](https://github.com/kubernetes-sigs/kubespray):
   - Следуйте официальной документации для развертывания кластера.
   - Проверьте доступность кластера через команду:
     ```bash
     kubectl cluster-info
     ```
2. Установите клиент `kubectl` (если он ещё не установлен) и настройте его для работы с кластером.
3. Ответьте на вопросы:
   - Какие шаги требуются для развертывания кластера с использованием Kubespray?
   - Как проверить статус узлов в кластере?

---

### 6. Развертывание приложения в Kubernetes

1. Запустите приложение в Kubernetes:
   ```bash
   kubectl run kubia --image=<ваш_docker_hub_id>/kubia --port=8080 --generator=run/v1
   ```
2. Проверьте статус запущенных модулей:
   ```bash
   kubectl get pods
   ```
3. Создайте объект службы:
   ```bash
   kubectl expose rc kubia --type=LoadBalancer --name=kubia-http
   ```
4. Найдите внешний IP-адрес службы:
   ```bash
   kubectl get svc
   ```
5. Доступ к приложению:
   ```bash
   curl <внешний_ip>:8080
   ```
6. Ответьте на вопросы:
   - Чем отличаются модули (pods) от контейнеров?
   - Какова роль служб (services) в Kubernetes?

---

### 7. Горизонтальное масштабирование

1. Масштабируйте приложение до 3 реплик:
   ```bash
   kubectl scale rc kubia --replicas=3
   ```
2. Проверьте статус контроллера репликации и модулей:
   ```bash
   kubectl get rc
   kubectl get pods
   ```
3. Ответьте на вопросы:
   - Как Kubernetes распределяет запросы между модулями?
   - Что произойдет при удалении одного из модулей?

---

### 8. Дополнительное задание

1. Исследуйте файловую систему контейнера изнутри, используя команду:
   ```bash
   docker exec -it kubia-container bash
   ```
2. Узнайте больше о модуле с помощью команды:
   ```bash
   kubectl describe pod <имя_модуля>
   ```
3. Создайте новую службу типа `NodePort` для модуля `kubia`, чтобы открыть доступ через порт хоста.
   ```bash
   kubectl expose rc kubia --type=NodePort --name=kubia-nodeport
   ```
4. Настройте ограничение ресурсов (CPU и памяти) для модуля `kubia`, отредактировав контроллер репликации.
   ```bash
   kubectl edit rc kubia
   ```
   Укажите следующие значения:
   ```yaml
   resources:
     requests:
       memory: "64Mi"
       cpu: "250m"
     limits:
       memory: "128Mi"
       cpu: "500m"
   ```
5. Настройте автоматическое масштабирование на основе загрузки CPU для модуля `kubia`.
   ```bash
   kubectl autoscale rc kubia --min=1 --max=5 --cpu-percent=50
   ```

---

### 9. Дополнительные задания (для повторения)

1. Проверьте логи работающего контейнера, используя подходящую команду. Попробуйте изменить уровень детализации.
2. Запустите второй экземпляр контейнера `kubia` на другой машине (используя Docker), подключитесь к нему и проверьте, как приложение отвечает на запросы.
3. Создайте несколько модулей в Kubernetes вручную, используя объект `Pod`, без применения контроллера репликации.
4. Измените команду запуска контейнера в объекте `Pod` через редактирование манифеста.
5. Создайте объект `ConfigMap` и используйте его для передачи конфигурации в приложение, работающее в контейнере.
6. Удалите один из модулей приложения `kubia` и проверьте, как контроллер репликации автоматически восстанавливает его.
7. Создайте пространство имен (namespace) в Kubernetes и запустите приложение `kubia` в этом пространстве.

---

## Вопросы для закрепления

1. Чем отличаются модули (pods), контроллеры репликации (replication controllers) и службы (services)?
2. Какой IP-адрес используется для доступа к модулю извне?
3. Какой параметр отвечает за количество реплик в контроллере репликации?
4. Какие преимущества предоставляет использование Kubespray для развертывания кластера?
5. Какую роль выполняет команда `kubectl expose`?
6. Почему важно делать образы контейнеров доступными в Docker Hub?
7. Какие инструменты можно использовать для настройки многоузлового кластера Kubernetes?
8. Какие ограничения можно наложить на ресурсы контейнера и как это сделать?
9. В чем преимущества автоматического масштабирования приложений в Kubernetes?
10. Как обеспечивается безопасность в кластере Kubernetes при помощи RBAC?
