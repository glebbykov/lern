
# Лабораторная работа №12: Внутренние механизмы Docker (Расширенная версия)

## Цели работы
1. Глубже изучить архитектуру Docker и его внутренние компоненты.
2. Освоить детальный анализ namespaces и cgroups контейнеров.
3. Понять, как Docker взаимодействует с ядром Linux.
4. Исследовать внутренние процессы Docker, такие как OverlayFS и сетевые взаимодействия.
5. Научиться применять полученные знания для диагностики и оптимизации работы контейнеров.

---

## 1. Теоретическая часть
### Архитектура Docker
- **Глубокий разбор Docker Daemon:**
  - Компоненты Docker Engine: контейнеры, образы, сети, тома.
  - Как Docker взаимодействует с контейнерной библиотекой runc.

### Механизмы изоляции
- **Namespaces:**
  - Подробный разбор типов namespaces (PID, NET, MNT, UTS, IPC, USER).
  - Как Docker применяет namespaces для изоляции процессов.
- **Cgroups:**
  - Ограничение и управление ресурсами: CPU, память, I/O.
  - Приоритеты и квоты для контейнеров.

### OverlayFS
- **Слои файловой системы:**
  - Как Docker использует OverlayFS для объединения слоев образов.
  - Механизмы Copy-on-Write (COW).

### Сетевой стек Docker
- **Bridge, Host, Overlay:**
  - Как Docker настраивает сети для контейнеров.
  - Взаимодействие с iptables и виртуальными интерфейсами.

### Взаимодействие с ядром Linux
- Как Docker использует системные вызовы (syscalls) для управления контейнерами.
- Анализ процессов с помощью `strace`.

---

## 2. Практическая часть
### Анализ namespaces
1. Запустите контейнер с пользовательским именем:
    ```bash
    docker run -d --name complex-container alpine sleep 3600
    ```

2. Найдите PID процесса контейнера на хосте:
    ```bash
    docker inspect --format '{{.State.Pid}}' complex-container
    ```

3. Используя `nsenter`, проанализируйте изоляцию контейнера в каждом namespace:
    ```bash
    nsenter --target <PID> --mount --uts --ipc --net --pid bash
    ```

4. Сравните окружение процессов внутри и вне контейнера.

### Глубокий анализ cgroups
1. Проверьте использование ресурсов контейнером через cgroups:
    ```bash
    cat /sys/fs/cgroup/memory/docker/<container-id>/memory.usage_in_bytes
    cat /sys/fs/cgroup/cpu/docker/<container-id>/cpuacct.usage
    ```

2. Ограничьте использование ресурсов контейнером и проверьте их выполнение:
    ```bash
    docker update --memory 100m --cpus 0.5 complex-container
    ```

### OverlayFS в действии
1. Найдите путь OverlayFS для контейнера:
    ```bash
    docker inspect --format '{{.GraphDriver.Data.MergedDir}}' complex-container
    ```

2. Создайте файл внутри контейнера и проверьте, где он находится в файловой системе хоста:
    ```bash
    docker exec complex-container sh -c "echo 'Hello OverlayFS' > /data.txt"
    find /var/lib/docker -name data.txt
    ```

3. Проанализируйте механизмы Copy-on-Write.

### Анализ сетевого взаимодействия
1. Проверьте использование виртуальных интерфейсов контейнером:
    ```bash
    ip link show
    ```

2. Настройте пользовательскую сеть и подключите к ней два контейнера:
    ```bash
    docker network create my-complex-network
    docker run -d --name container1 --network my-complex-network alpine sleep 3600
    docker run -d --name container2 --network my-complex-network alpine sleep 3600
    ```

3. Проверьте взаимодействие между контейнерами:
    ```bash
    docker exec container1 ping container2
    ```

### Взаимодействие с ядром Linux
1. Используйте `strace` для анализа системных вызовов контейнера:
    ```bash
    strace -p <PID>
    ```

2. Проанализируйте ключевые системные вызовы, используемые Docker для управления контейнером.

---

## 3. Теоретические вопросы
1. Как Docker использует namespaces для изоляции контейнеров?
2. Какие ресурсы можно ограничить с помощью cgroups?
3. Чем OverlayFS отличается от других типов файловых систем?
4. Как Docker управляет сетевыми взаимодействиями контейнеров через iptables?
5. Какие системные вызовы используются Docker для создания и удаления контейнеров?

---

## 4. Дополнительные задания
1. **Анализ пользовательских namespaces:**
   - Настройте контейнер с пользовательскими namespaces и проверьте его привилегии.

2. **Тестирование ограничения ресурсов:**
   - Проверьте поведение контейнера при исчерпании выделенных ресурсов.

3. **Проблемы Copy-on-Write:**
   - Создайте сценарий, который тестирует производительность OverlayFS при интенсивном копировании данных.

4. **Диагностика проблем:**
   - Используйте `strace` и системные логи для диагностики проблем с запуском контейнера.
